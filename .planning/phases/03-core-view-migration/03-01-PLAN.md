---
phase: 03-core-view-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scrapegrape/publishers/views.py
  - scrapegrape/frontend/src/Pages/Publishers/Index.tsx
  - scrapegrape/templates/base.html
  - scrapegrape/frontend/src/main.tsx
autonomous: true

must_haves:
  truths:
    - "User loads / and sees publisher table with all columns rendered via Inertia props (not JSON script tag parsing)"
    - "User can sort, filter, and expand table rows exactly as before the migration"
    - "Existing Subquery optimization preserved (query count stays at ~4, not N+1)"
  artifacts:
    - path: "scrapegrape/publishers/views.py"
      provides: "Inertia-based table view using inertia_render()"
      contains: "inertia_render"
    - path: "scrapegrape/frontend/src/Pages/Publishers/Index.tsx"
      provides: "Inertia page component wrapping existing DataTable"
      min_lines: 10
    - path: "scrapegrape/templates/base.html"
      provides: "Template without legacy #root div"
  key_links:
    - from: "scrapegrape/publishers/views.py"
      to: "scrapegrape/frontend/src/Pages/Publishers/Index.tsx"
      via: "inertia_render(request, 'Publishers/Index', props={...})"
      pattern: "inertia_render.*Publishers/Index"
    - from: "scrapegrape/frontend/src/Pages/Publishers/Index.tsx"
      to: "scrapegrape/frontend/src/datatable/table.tsx"
      via: "DataTable component import with props.publishers as data"
      pattern: "DataTable.*columns.*data"
    - from: "scrapegrape/frontend/src/main.tsx"
      to: "scrapegrape/frontend/src/Pages/Publishers/Index.tsx"
      via: "import.meta.glob('./Pages/**/*.tsx') page resolution"
      pattern: "import\\.meta\\.glob"
---

<objective>
Convert the publisher table view from Django template JSON embedding to Inertia direct prop passing, and create the corresponding React page component.

Purpose: This is the core architectural migration -- replacing the json_script template tag pattern with Inertia's render() so data flows directly from Django view to React component as typed props. Satisfies VIEW-01 (view conversion) and VIEW-02 (DRF serializer reuse).

Output: Publisher table at "/" renders identically but via Inertia prop passing instead of JSON script tag parsing.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-view-migration/03-RESEARCH.md
@scrapegrape/publishers/views.py
@scrapegrape/publishers/serializers.py
@scrapegrape/frontend/src/main.tsx
@scrapegrape/frontend/src/App.tsx
@scrapegrape/frontend/src/datatable/columns.tsx
@scrapegrape/frontend/src/datatable/table.tsx
@scrapegrape/templates/base.html
@scrapegrape/templates/index.html
@scrapegrape/scrapegrape/urls.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert Django view to Inertia and create Publishers/Index page component</name>
  <files>
    scrapegrape/publishers/views.py
    scrapegrape/frontend/src/Pages/Publishers/Index.tsx
  </files>
  <action>
**In scrapegrape/publishers/views.py:**
Change the `table()` view to return an Inertia response instead of a template render. The ONLY change is the return statement -- ALL existing Subquery logic, bulk fetching, and serialization MUST remain identical (this is critical for VIEW-02 and performance).

Replace:
```python
return render(request, "index.html", {"serialized": serialized.data})
```
With:
```python
return inertia_render(request, 'Publishers/Index', props={
    'publishers': serialized.data
})
```

The `inertia_render` import already exists at the top of the file (added in Phase 1). Remove the `from django.shortcuts import render` import since it will no longer be used by the `table()` function (but verify `inertia_smoke_test` does not use it either -- it does not, it uses `inertia_render`).

**In scrapegrape/frontend/src/Pages/Publishers/Index.tsx (NEW):**
Create the Inertia page component that wraps the existing DataTable. This component receives `publishers` as a prop directly from Django (no JSON parsing, no useEffect, no useState).

```typescript
import { DataTable } from '@/datatable/table'
import { columns, type Publisher } from '@/datatable/columns'

interface Props {
    publishers: Publisher[]
}

export default function Index({ publishers }: Props) {
    return (
        <div className="container mx-auto py-10">
            <h1 className="text-2xl mb-4">Publishers</h1>
            <DataTable columns={columns} data={publishers} />
        </div>
    )
}
```

Key points:
- Default export is required for Inertia page resolution via import.meta.glob
- Props interface matches the `publishers` key from the Django view's props dict
- Publisher type imported from existing columns.tsx (already matches DRF serializer output)
- Layout/styling matches existing App.tsx (container mx-auto py-10, h1 text-2xl mb-4)
- No useState, no useEffect, no JSON.parse -- props arrive directly from Inertia
  </action>
  <verify>
1. Run `cd /Users/matt/src/itsascout/scrapegrape/frontend && npx tsc --noEmit` to verify TypeScript compilation passes
2. Run `cd /Users/matt/src/itsascout/scrapegrape/frontend && npm run build` to verify Vite build succeeds and Pages/Publishers/Index.tsx is included in bundle
3. Verify scrapegrape/publishers/views.py no longer imports `render` from django.shortcuts (or if it does, it's unused by any function)
  </verify>
  <done>
- views.py table() returns inertia_render() with props={'publishers': serialized.data}
- Pages/Publishers/Index.tsx exists with default export receiving typed publishers prop
- TypeScript compiles without errors
- Vite build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Update base template and clean up legacy rendering path</name>
  <files>
    scrapegrape/templates/base.html
    scrapegrape/frontend/src/main.tsx
  </files>
  <action>
**In scrapegrape/templates/base.html:**
Remove the `<div id="root"></div>` element. Now that "/" is served via Inertia, the legacy mount point is no longer needed for any user-facing route. The Inertia middleware injects `<div id="app" data-page="...">` via `{% block inertia %}` automatically.

Before:
```html
<body>
    {% block inertia %}{% endblock %}
    <div id="root"></div>
    {% block extra_body %}{% endblock %}
</body>
```

After:
```html
<body>
    {% block inertia %}{% endblock %}
    {% block extra_body %}{% endblock %}
</body>
```

NOTE: The smoke test at /_debug/inertia/ uses Inertia (not #root), so removing #root does not affect it. Verify no other templates extend base.html and depend on #root. The only template that extended base.html with extra content was index.html (which used extra_body for json_script), and that template is no longer referenced by any view after Task 1.

**In scrapegrape/frontend/src/main.tsx:**
Remove the legacy fallback branch (the `else` block that dynamically imports App.tsx and mounts on #root). Since #root no longer exists in the template and "/" is now an Inertia route, the legacy path is dead code.

The file should become:
```typescript
import { createInertiaApp } from '@inertiajs/react'
import { createRoot } from 'react-dom/client'
import axios from 'axios'
import './index.css'

// Configure CSRF for Django compatibility (INRT-04)
axios.defaults.xsrfHeaderName = "X-CSRFToken"
axios.defaults.xsrfCookieName = "csrftoken"

createInertiaApp({
    resolve: name => {
        const pages = import.meta.glob('./Pages/**/*.tsx', { eager: true })
        const page = pages[`./Pages/${name}.tsx`]
        if (!page) {
            throw new Error(
                `Page not found: ${name}. Available: ${Object.keys(pages).join(', ')}`
            )
        }
        return page
    },
    setup({ el, App, props }) {
        createRoot(el).render(<App {...props} />)
    },
})
```

Key changes:
- Removed StrictMode import (was only used in legacy path)
- Removed inertiaRoot detection logic (no longer conditional)
- Removed legacy else branch (dynamic App.tsx import + #root mount)
- createInertiaApp is now the only code path
- CSRF configuration and index.css import preserved
  </action>
  <verify>
1. Run `cd /Users/matt/src/itsascout/scrapegrape/frontend && npx tsc --noEmit` to verify TypeScript still compiles
2. Run `cd /Users/matt/src/itsascout/scrapegrape/frontend && npm run build` to verify build succeeds
3. Grep for "root" in base.html to confirm #root div is removed
4. Grep for "App.tsx" or "legacyRoot" in main.tsx to confirm legacy path is removed
  </verify>
  <done>
- base.html no longer contains `<div id="root">`
- main.tsx has only the Inertia code path (no legacy branch)
- TypeScript compiles and Vite build succeeds
- index.html template is no longer referenced by any view (orphaned, cleanup deferred to Phase 5)
  </done>
</task>

</tasks>

<verification>
1. Start Django dev server and load http://localhost:8000/ -- publisher table should render with all columns (Publisher, WAF, Terms URL) and expandable rows
2. Verify sorting works: click column headers, rows reorder
3. Verify filtering works: use any filter controls
4. Verify row expansion works: click "+" on rows with permissions, details expand below
5. Verify network tab shows Inertia response (JSON with component: "Publishers/Index" and props.publishers array)
6. Verify /_debug/inertia/ smoke test still works
7. Verify /admin/ still accessible
8. Check Django Debug Toolbar (if available) that query count is ~4 (not N+1)
</verification>

<success_criteria>
- Publisher table at "/" renders identically to pre-migration (same columns, same data, same interactions)
- Data flows as Inertia props (no json_script, no JSON.parse in React)
- DRF serializers reused unchanged (VIEW-02)
- Subquery optimization preserved
- Smoke test at /_debug/inertia/ still works
- Django admin at /admin/ still works
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-view-migration/03-01-SUMMARY.md`
</output>
