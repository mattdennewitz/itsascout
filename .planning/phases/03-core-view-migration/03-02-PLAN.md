---
phase: 03-core-view-migration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - scrapegrape/scrapegrape/middleware.py
  - scrapegrape/scrapegrape/settings.py
  - scrapegrape/frontend/src/Layouts/AppLayout.tsx
  - scrapegrape/frontend/src/Pages/Publishers/Index.tsx
autonomous: false

must_haves:
  truths:
    - "Flash messages and auth state are available as shared props on every Inertia page load"
    - "AppLayout persists across page navigations without remounting"
    - "Navigation uses Inertia Link component for SPA-like transitions"
  artifacts:
    - path: "scrapegrape/scrapegrape/middleware.py"
      provides: "Shared data middleware injecting user and flash props"
      contains: "inertia_share"
    - path: "scrapegrape/frontend/src/Layouts/AppLayout.tsx"
      provides: "Persistent layout with navigation using Inertia Link"
      min_lines: 15
    - path: "scrapegrape/frontend/src/Pages/Publishers/Index.tsx"
      provides: "Page component with .layout property for persistent layout"
      contains: ".layout"
    - path: "scrapegrape/scrapegrape/settings.py"
      provides: "Middleware registration for inertia_share"
      contains: "scrapegrape.middleware.inertia_share"
  key_links:
    - from: "scrapegrape/scrapegrape/middleware.py"
      to: "scrapegrape/frontend/src/Layouts/AppLayout.tsx"
      via: "Shared props (user, flash) injected by middleware, consumed in layout"
      pattern: "share.*user.*flash"
    - from: "scrapegrape/frontend/src/Layouts/AppLayout.tsx"
      to: "scrapegrape/frontend/src/Pages/Publishers/Index.tsx"
      via: "Persistent layout assignment via Index.layout property"
      pattern: "\\.layout"
    - from: "scrapegrape/frontend/src/Layouts/AppLayout.tsx"
      to: "@inertiajs/react"
      via: "Link component for SPA navigation"
      pattern: "Link.*href"
---

<objective>
Add shared data middleware for flash messages and auth state, create a persistent AppLayout with Inertia Link navigation, and wire it to the Publishers/Index page component.

Purpose: Completes INRT-05 (Link navigation), INRT-06 (shared data), and INRT-07 (persistent layouts) -- the remaining Phase 3 requirements that build Inertia patterns on top of the core view migration.

Output: Every Inertia page receives shared user/flash props, pages render inside a persistent layout with Link-based navigation.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-view-migration/03-RESEARCH.md
@.planning/phases/03-core-view-migration/03-01-SUMMARY.md
@scrapegrape/scrapegrape/settings.py
@scrapegrape/frontend/src/Pages/Publishers/Index.tsx
@scrapegrape/frontend/src/Layouts/.gitkeep
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared data middleware and register in Django settings</name>
  <files>
    scrapegrape/scrapegrape/middleware.py
    scrapegrape/scrapegrape/settings.py
  </files>
  <action>
**Create scrapegrape/scrapegrape/middleware.py (NEW FILE):**

Create the shared data middleware that injects user authentication state and flash messages into every Inertia response. Use `inertia.share()` with lambda functions for lazy evaluation (data only computed when Inertia actually renders a response, not on every request like admin or static file requests).

```python
from inertia import share


def inertia_share(get_response):
    def middleware(request):
        share(request,
            # User authentication state -- available as props.auth.user on all pages
            auth=lambda: {
                'user': {
                    'id': request.user.id,
                    'username': request.user.username,
                    'is_authenticated': request.user.is_authenticated,
                } if request.user.is_authenticated else None,
            },

            # Flash messages -- auto-clear from session on read
            flash=lambda: {
                'success': request.session.pop('success', None),
                'error': request.session.pop('error', None),
                'info': request.session.pop('info', None),
            },
        )
        return get_response(request)
    return middleware
```

Key points:
- Lambda wrapping ensures lazy evaluation (not computed for non-Inertia requests)
- `auth.user` is None when not authenticated (safe for anonymous access)
- Flash messages use session.pop() to auto-clear after being read
- Follows the official inertia-django shared data pattern from 03-RESEARCH.md

**In scrapegrape/scrapegrape/settings.py:**

Add the shared data middleware to MIDDLEWARE list. It MUST be placed AFTER `MessageMiddleware` (needs messages framework) and AFTER `AuthenticationMiddleware` (needs request.user). Position it just before `XFrameOptionsMiddleware`.

Change MIDDLEWARE from:
```python
MIDDLEWARE = [
    "django.middleware.security.SecurityMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "inertia.middleware.InertiaMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
]
```

To:
```python
MIDDLEWARE = [
    "django.middleware.security.SecurityMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "inertia.middleware.InertiaMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "scrapegrape.middleware.inertia_share",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
]
```
  </action>
  <verify>
1. Run `cd /Users/matt/src/itsascout/scrapegrape && python manage.py check` to verify Django system checks pass (validates middleware can be imported)
2. Verify middleware.py exists at scrapegrape/scrapegrape/middleware.py
3. Grep settings.py for "scrapegrape.middleware.inertia_share" to confirm registration
  </verify>
  <done>
- middleware.py exists with inertia_share function using share() for auth and flash data
- settings.py MIDDLEWARE includes "scrapegrape.middleware.inertia_share" after MessageMiddleware
- Django system checks pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Create persistent AppLayout with Link navigation and assign to Publishers/Index</name>
  <files>
    scrapegrape/frontend/src/Layouts/AppLayout.tsx
    scrapegrape/frontend/src/Pages/Publishers/Index.tsx
  </files>
  <action>
**Create scrapegrape/frontend/src/Layouts/AppLayout.tsx (NEW FILE, replaces .gitkeep):**

Create the persistent layout component that wraps all pages. It should include:
- A nav bar with the app name as an Inertia Link to "/"
- Display of flash messages from shared data (success/error/info)
- Auth state display (username if logged in)
- A main content area for the page component

```typescript
import { Link, usePage } from '@inertiajs/react'
import { ReactNode, useEffect, useState } from 'react'

interface SharedProps {
    auth: {
        user: {
            id: number
            username: string
            is_authenticated: boolean
        } | null
    }
    flash: {
        success: string | null
        error: string | null
        info: string | null
    }
}

export default function AppLayout({ children }: { children: ReactNode }) {
    const { auth, flash } = usePage<{ props: SharedProps }>().props as unknown as SharedProps
    const [showFlash, setShowFlash] = useState(false)

    useEffect(() => {
        if (flash?.success || flash?.error || flash?.info) {
            setShowFlash(true)
            const timer = setTimeout(() => setShowFlash(false), 5000)
            return () => clearTimeout(timer)
        }
    }, [flash])

    return (
        <div className="min-h-screen bg-gray-50">
            <nav className="bg-white shadow-sm border-b">
                <div className="container mx-auto px-4 py-3 flex items-center justify-between">
                    <Link href="/" className="text-lg font-bold text-gray-900 hover:text-gray-700">
                        Scrapegrape
                    </Link>
                    <div className="flex items-center gap-4">
                        <Link
                            href="/"
                            className="text-sm text-gray-600 hover:text-gray-900"
                        >
                            Publishers
                        </Link>
                        {auth?.user && (
                            <span className="text-sm text-gray-500">
                                {auth.user.username}
                            </span>
                        )}
                    </div>
                </div>
            </nav>

            {showFlash && (
                <div className="container mx-auto px-4 pt-4">
                    {flash?.success && (
                        <div className="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded mb-2">
                            {flash.success}
                        </div>
                    )}
                    {flash?.error && (
                        <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded mb-2">
                            {flash.error}
                        </div>
                    )}
                    {flash?.info && (
                        <div className="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded mb-2">
                            {flash.info}
                        </div>
                    )}
                </div>
            )}

            <main>
                {children}
            </main>
        </div>
    )
}
```

Key points:
- Uses `usePage()` to access shared data injected by middleware
- Link component from @inertiajs/react provides SPA-like navigation (INRT-05)
- Flash messages auto-dismiss after 5 seconds
- Layout structure is minimal -- nav + flash + main content
- Tailwind classes follow existing project conventions

**Modify scrapegrape/frontend/src/Pages/Publishers/Index.tsx:**

Add the persistent layout assignment using the `.layout` property pattern. This tells Inertia to wrap this page in AppLayout and preserve the layout instance across navigations (INRT-07).

The updated file should be:
```typescript
import { DataTable } from '@/datatable/table'
import { columns, type Publisher } from '@/datatable/columns'
import AppLayout from '@/Layouts/AppLayout'
import { ReactNode } from 'react'

interface Props {
    publishers: Publisher[]
}

function Index({ publishers }: Props) {
    return (
        <div className="container mx-auto py-10">
            <h1 className="text-2xl mb-4">Publishers</h1>
            <DataTable columns={columns} data={publishers} />
        </div>
    )
}

// Persistent layout: AppLayout instance preserved across page navigations
Index.layout = (page: ReactNode) => <AppLayout>{page}</AppLayout>

export default Index
```

Key changes from Plan 01 version:
- Import AppLayout and ReactNode
- Changed from `export default function` to named function + separate `export default`
- Added `.layout` property for persistent layout assignment
- Layout wraps the page but page content is unchanged

Delete the .gitkeep file from Layouts/ since it now has a real file:
- Remove scrapegrape/frontend/src/Layouts/.gitkeep
  </action>
  <verify>
1. Run `cd /Users/matt/src/itsascout/scrapegrape/frontend && npx tsc --noEmit` to verify TypeScript compilation
2. Run `cd /Users/matt/src/itsascout/scrapegrape/frontend && npm run build` to verify Vite build succeeds
3. Verify AppLayout.tsx exists and contains Link import from @inertiajs/react
4. Verify Index.tsx contains `.layout` property assignment
  </verify>
  <done>
- AppLayout.tsx exists in Layouts/ with Link navigation, flash messages, and auth display
- Publishers/Index.tsx has .layout property assigning AppLayout as persistent layout
- TypeScript compiles and Vite build succeeds
- .gitkeep removed from Layouts/
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Inertia migration with layout and shared data</name>
  <files>
    scrapegrape/scrapegrape/middleware.py
    scrapegrape/frontend/src/Layouts/AppLayout.tsx
    scrapegrape/frontend/src/Pages/Publishers/Index.tsx
  </files>
  <action>
Human verification checkpoint. All code was automated in Tasks 1-2. This task verifies the complete Phase 3 migration works end-to-end: publisher table view converted to Inertia (Plan 01), shared data middleware for auth/flash messages, persistent AppLayout with Link navigation, all wired together.
  </action>
  <verify>
1. Start the dev server: `cd /Users/matt/src/itsascout/scrapegrape && python manage.py runserver`
2. Load http://localhost:8000/ in browser
3. Verify publisher table renders with all columns (Publisher, WAF, Terms URL)
4. Verify a nav bar appears at the top with "Scrapegrape" and "Publishers" links
5. Click "Publishers" link in nav -- page should NOT do a full reload (no white flash, SPA-like transition)
6. Verify sorting works: click column headers
7. Verify row expansion works: click "+" on rows with permissions
8. Open browser DevTools Network tab, click the "Publishers" nav link:
   - Should see XHR request (not document request)
   - Response should be JSON with component: "Publishers/Index"
   - Response should include shared props (auth, flash)
9. Verify /admin/ still works at http://localhost:8000/admin/
10. Verify /_debug/inertia/ smoke test still works at http://localhost:8000/_debug/inertia/
  </verify>
  <done>
- User confirms publisher table renders correctly at / with nav layout
- Inertia Link navigation works without full page reload
- Shared data (auth, flash) present in Inertia response props
- All existing functionality preserved (sort, filter, expand)
- /admin/ and /_debug/inertia/ still work
  </done>
</task>

</tasks>

<verification>
1. Django manage.py check passes (middleware valid)
2. TypeScript compiles without errors
3. Vite build succeeds
4. Publisher table at "/" renders with navigation layout
5. Inertia Link provides SPA-like navigation (no full page reload)
6. Shared data (auth, flash) available in page props
7. Layout persists across navigation (no remount)
8. All existing functionality preserved (sort, filter, expand)
9. /admin/ and /_debug/inertia/ still work
</verification>

<success_criteria>
- Shared data middleware injects auth and flash props on every Inertia response (INRT-06)
- AppLayout persists across page navigations (INRT-07)
- Navigation uses Inertia Link component (INRT-05)
- Flash messages display and auto-dismiss
- Auth state shows username when logged in
- All existing table functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-view-migration/03-02-SUMMARY.md`
</output>
