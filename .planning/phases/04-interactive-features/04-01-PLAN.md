---
phase: 04-interactive-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scrapegrape/publishers/forms.py
  - scrapegrape/publishers/views.py
  - scrapegrape/scrapegrape/urls.py
  - scrapegrape/scrapegrape/middleware.py
  - scrapegrape/frontend/src/Pages/Publishers/Create.tsx
  - scrapegrape/frontend/src/Pages/Publishers/Edit.tsx
  - scrapegrape/frontend/src/Pages/Publishers/BulkUpload.tsx
  - scrapegrape/frontend/src/Components/FormField.tsx
  - scrapegrape/frontend/src/Components/ProgressBar.tsx
  - scrapegrape/frontend/src/Pages/Publishers/Index.tsx
  - scrapegrape/frontend/package.json
autonomous: true

must_haves:
  truths:
    - "User can create a new publisher via form with name and URL fields"
    - "User sees inline validation errors when form submission fails (e.g., missing name, invalid URL)"
    - "User can edit an existing publisher's name and URL"
    - "User can upload a CSV file and see upload progress percentage"
    - "CSV upload queues URLs for background analysis and redirects with success flash message"
    - "Processing/disabled state prevents double-submit on all forms"
  artifacts:
    - path: "scrapegrape/publishers/forms.py"
      provides: "PublisherForm and BulkUploadForm Django form classes"
      contains: "class PublisherForm"
    - path: "scrapegrape/publishers/views.py"
      provides: "create, update, bulk_upload view functions"
      contains: "def create"
    - path: "scrapegrape/scrapegrape/urls.py"
      provides: "Routes for create, edit, bulk upload"
      contains: "publishers/create"
    - path: "scrapegrape/scrapegrape/middleware.py"
      provides: "Shared errors prop for useForm validation error mapping"
      contains: "errors"
    - path: "scrapegrape/frontend/src/Pages/Publishers/Create.tsx"
      provides: "Publisher creation form with useForm"
      contains: "useForm"
    - path: "scrapegrape/frontend/src/Pages/Publishers/Edit.tsx"
      provides: "Publisher edit form with useForm"
      contains: "useForm"
    - path: "scrapegrape/frontend/src/Pages/Publishers/BulkUpload.tsx"
      provides: "CSV upload form with progress tracking"
      contains: "progress"
    - path: "scrapegrape/frontend/src/Components/FormField.tsx"
      provides: "Reusable form field with error display"
      exports: ["FormField"]
    - path: "scrapegrape/frontend/src/Components/ProgressBar.tsx"
      provides: "Upload progress bar component"
      exports: ["ProgressBar"]
  key_links:
    - from: "scrapegrape/frontend/src/Pages/Publishers/Create.tsx"
      to: "/publishers/create"
      via: "useForm post()"
      pattern: "post.*publishers/create"
    - from: "scrapegrape/frontend/src/Pages/Publishers/Edit.tsx"
      to: "/publishers/<id>/edit"
      via: "useForm post()"
      pattern: "post.*publishers.*edit"
    - from: "scrapegrape/frontend/src/Pages/Publishers/BulkUpload.tsx"
      to: "/publishers/bulk-upload"
      via: "useForm post() with file"
      pattern: "post.*bulk-upload"
    - from: "scrapegrape/publishers/views.py"
      to: "scrapegrape/publishers/forms.py"
      via: "PublisherForm and BulkUploadForm import"
      pattern: "from publishers.forms import"
    - from: "scrapegrape/publishers/views.py"
      to: "session errors"
      via: "Flash form.errors to session, redirect back; middleware shares errors as prop"
      pattern: "request.session.*errors"
    - from: "scrapegrape/scrapegrape/middleware.py"
      to: "useForm errors"
      via: "Shared 'errors' prop auto-consumed by useForm hook on frontend"
      pattern: "errors.*request.session"
---

<objective>
Implement form submissions (create publisher, edit publisher, bulk CSV upload) using Inertia useForm hook with Django form validation and session-based error passing for inline error display.

Purpose: Delivers INRT-08 (useForm with validation errors). Establishes the form submission pattern: backend Django Forms validate, errors flash to session, shared data middleware passes errors as page prop, frontend useForm hook automatically maps errors to fields.

Output: Three new page components (Create, Edit, BulkUpload), two reusable UI components (FormField, ProgressBar), Django forms, view functions, URL routes, and updated shared data middleware.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-interactive-features/04-RESEARCH.md

@scrapegrape/publishers/views.py
@scrapegrape/publishers/models.py
@scrapegrape/publishers/serializers.py
@scrapegrape/publishers/tasks.py
@scrapegrape/scrapegrape/urls.py
@scrapegrape/scrapegrape/middleware.py
@scrapegrape/frontend/src/Pages/Publishers/Index.tsx
@scrapegrape/frontend/src/Layouts/AppLayout.tsx
@scrapegrape/frontend/src/datatable/columns.tsx
@scrapegrape/frontend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Django forms, backend views with session-based validation errors, URL routes, and update shared data middleware</name>
  <files>
    scrapegrape/publishers/forms.py
    scrapegrape/publishers/views.py
    scrapegrape/scrapegrape/urls.py
    scrapegrape/scrapegrape/middleware.py
  </files>
  <action>
**CRITICAL: InertiaValidationError does NOT exist in inertia-django 1.2.0.** The research recommended it but the installed package does not have it. The correct validation pattern for django-inertia is:
1. Store form errors dict in `request.session['errors']`
2. Redirect back to the form page (302)
3. Shared data middleware passes `errors` from session as a shared prop
4. Inertia's useForm hook on the frontend automatically reads the `errors` page prop and maps it to field-level errors

**1. Update `scrapegrape/scrapegrape/middleware.py`** to add an `errors` shared prop:

Add `errors` to the existing `share()` call. The errors must be a dict of `{field_name: error_message_string}` for useForm to map them correctly. Django form.errors returns `{field: [list_of_messages]}` so we need to flatten to first message per field:

```python
share(request,
    auth=lambda: { ... },  # existing, keep unchanged
    flash=lambda: { ... },  # existing, keep unchanged
    errors=lambda: request.session.pop('errors', {}),
)
```

**2. Create `scrapegrape/publishers/forms.py`** with two form classes:

- `PublisherForm(forms.ModelForm)`: Meta model=Publisher, fields=['name', 'url']. Add `clean_url` method that validates URL starts with http:// or https://.
- `BulkUploadForm(forms.Form)`: Single FileField `csv_file` (required). Add `clean_csv_file` method that validates file extension is .csv and file size under 5MB.

**3. Add view functions to `scrapegrape/publishers/views.py`:**

Import at top: `from django.shortcuts import redirect, get_object_or_404`, `from publishers.forms import PublisherForm, BulkUploadForm`, `import csv`.

Do NOT import InertiaValidationError (it does not exist in inertia-django 1.2.0).

Add three new view functions (keep existing `table` and `inertia_smoke_test` unchanged):

- `create(request)`:
  - GET: return `inertia_render(request, 'Publishers/Create')`
  - POST: validate with `PublisherForm(request.POST)`. If valid: `publisher = form.save()`, enqueue `analyze_url.enqueue(publisher.url)`, set `request.session['success'] = f'Publisher "{publisher.name}" created and analysis queued!'`, return `redirect('/')`. If invalid: flatten form.errors to `{field: messages[0] for field, messages in form.errors.items()}`, store in `request.session['errors']`, return `redirect('/publishers/create')`.

- `update(request, publisher_id)`:
  - Fetch publisher with `get_object_or_404(Publisher, id=publisher_id)`.
  - GET: return `inertia_render(request, 'Publishers/Edit', props={'publisher': {'id': publisher.id, 'name': publisher.name, 'url': publisher.url}})`.
  - POST: validate with `PublisherForm(request.POST, instance=publisher)`. If valid: save, flash success, redirect to '/'. If invalid: flatten errors, store in session, redirect back to edit page `/publishers/{publisher_id}/edit`.

- `bulk_upload(request)`:
  - GET: return `inertia_render(request, 'Publishers/BulkUpload')`
  - POST: validate with `BulkUploadForm(request.POST, request.FILES)`. If valid: read CSV file (`request.FILES['csv_file']`), decode utf-8, use csv.DictReader, iterate rows calling `analyze_url.enqueue(row['URL'])` for each row with a 'URL' key, count enqueued URLs, flash success message `f'{count} URLs queued for analysis'`, redirect to '/'. If invalid: flatten errors, store in session, redirect back to `/publishers/bulk-upload`.

Create a helper at top of views.py to avoid repeating the error flattening:
```python
def _flash_errors(request, form):
    """Flatten Django form errors to {field: first_message} and store in session for Inertia useForm."""
    request.session['errors'] = {
        field: messages[0] for field, messages in form.errors.items()
    }
```

**4. Update `scrapegrape/scrapegrape/urls.py`:**

Add URL patterns (BEFORE the catch-all `""` pattern, AFTER admin and debug routes):
```python
path("publishers/create", publishers.views.create, name="publisher-create"),
path("publishers/<int:publisher_id>/edit", publishers.views.update, name="publisher-update"),
path("publishers/bulk-upload", publishers.views.bulk_upload, name="publisher-bulk-upload"),
```

**IMPORTANT:** Use `uv run python manage.py check` (not `python manage.py check`) for all Django commands.
  </action>
  <verify>
Run `cd /Users/matt/src/itsascout/scrapegrape && uv run python manage.py check` to validate no import errors or model issues. Output should include "System check identified no issues."
Verify the middleware shares errors: `cd /Users/matt/src/itsascout/scrapegrape && uv run python -c "from scrapegrape.middleware import inertia_share; print('middleware ok')"`
  </verify>
  <done>
Three Django view functions (create, update, bulk_upload) exist in views.py. PublisherForm and BulkUploadForm exist in forms.py. URL routes registered. Validation errors flashed to session as flat dict and shared via middleware `errors` prop. Django system check passes. No InertiaValidationError used (does not exist in installed package).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create frontend form pages (Create, Edit, BulkUpload) with useForm, reusable components, and navigation links</name>
  <files>
    scrapegrape/frontend/src/Components/FormField.tsx
    scrapegrape/frontend/src/Components/ProgressBar.tsx
    scrapegrape/frontend/src/Pages/Publishers/Create.tsx
    scrapegrape/frontend/src/Pages/Publishers/Edit.tsx
    scrapegrape/frontend/src/Pages/Publishers/BulkUpload.tsx
    scrapegrape/frontend/src/Pages/Publishers/Index.tsx
    scrapegrape/frontend/package.json
  </files>
  <action>
**0. Install react-papaparse:**

Run `cd /Users/matt/src/itsascout/scrapegrape/frontend && npm install react-papaparse`

**1. Create `scrapegrape/frontend/src/Components/FormField.tsx`:**

Reusable form field wrapper. Props: `label: string`, `error?: string`, `children: ReactNode`. Renders label, children (the input), and conditional red error text below. Use Tailwind classes: `block text-sm font-medium mb-2` for label, `text-sm text-red-600 mt-1` for error. Export as named export `FormField`.

**2. Create `scrapegrape/frontend/src/Components/ProgressBar.tsx`:**

Props: `percentage: number`. Renders a Tailwind progress bar: gray-200 background rounded-full h-2.5, blue-600 fill bar with dynamic width, percentage text above. Export as named export `ProgressBar`.

**3. Create `scrapegrape/frontend/src/Pages/Publishers/Create.tsx`:**

Use `useForm` from `@inertiajs/react` with `{ name: '', url: '' }` initial data. Destructure: `{ data, setData, post, processing, errors, reset }`.

On submit (FormEventHandler): `e.preventDefault()`, then `post('/publishers/create', { onSuccess: () => reset() })`.

Render a form with two FormField components (name and url). Each input uses `value={data.name}` / `onChange={e => setData('name', e.target.value)}`. Pass `error={errors.name}` to FormField. Style inputs with `w-full px-4 py-2 border rounded` and add `border-red-500` class when error exists.

Submit button: `disabled={processing}`, show "Creating..." when processing, "Create Publisher" otherwise. Style: `px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50`.

Add cancel `Link` (from @inertiajs/react) back to '/' styled as outline button.

Assign `.layout` property for persistent AppLayout (same pattern as Index.tsx):
```typescript
Create.layout = (page: ReactNode) => <AppLayout>{page}</AppLayout>
```

**4. Create `scrapegrape/frontend/src/Pages/Publishers/Edit.tsx`:**

Receives `publisher: { id: number, name: string, url: string }` prop. Use `useForm` initialized with `{ name: publisher.name, url: publisher.url }`. On submit: `post(\`/publishers/${publisher.id}/edit\`)`. Same FormField pattern as Create. Disable button when processing. Cancel links to '/'. Assign .layout for AppLayout.

**5. Create `scrapegrape/frontend/src/Pages/Publishers/BulkUpload.tsx`:**

Use `useForm` with `{ csv_file: null as File | null }`. Destructure: `{ data, setData, post, processing, progress, errors }`.

Handle file input change with client-side CSV validation:
- Use `usePapaParse` from `react-papaparse` to parse the file and check it has a 'URL' column header
- Use a local state `csvError` for client-side validation messages
- If CSV is valid, call `setData('csv_file', file)`. If invalid, show error and don't set file.

On submit: `e.preventDefault()`, then `post('/publishers/bulk-upload', { onSuccess: () => setData('csv_file', null) })`.

Show ProgressBar component when `progress` is available (`progress && <ProgressBar percentage={progress.percentage} />`). Show "Preparing upload..." text when `processing && !progress`. Disable submit button when `processing || !data.csv_file`.

Display server errors via `errors.csv_file` if present.

Assign .layout for AppLayout.

**6. Update `scrapegrape/frontend/src/Pages/Publishers/Index.tsx`:**

Add `Link` import from `@inertiajs/react` (may already be available from prior changes, verify).

Add navigation links between the h1 heading and the DataTable:
```tsx
<div className="flex justify-between items-center mb-6">
    <h1 className="text-2xl font-bold">Publishers</h1>
    <div className="flex gap-2">
        <Link
            href="/publishers/create"
            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
        >
            Add Publisher
        </Link>
        <Link
            href="/publishers/bulk-upload"
            className="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50"
        >
            Bulk Upload
        </Link>
    </div>
</div>
```

Remove the existing plain `<h1>` tag and replace with the above flex container.

**Key patterns to follow:**
- All page components use `ComponentName.layout = (page: ReactNode) => <AppLayout>{page}</AppLayout>` pattern (match Index.tsx exactly)
- Import `type { ReactNode }` from 'react' for layout typing
- Use `@/Components/FormField` and `@/Components/ProgressBar` path aliases
- All forms prevent default on submit event
- Import `Link` from `@inertiajs/react` for navigation
  </action>
  <verify>
Run `cd /Users/matt/src/itsascout/scrapegrape/frontend && npx tsc --noEmit` to verify TypeScript compilation.
Run `cd /Users/matt/src/itsascout/scrapegrape/frontend && npm run build` to verify Vite build succeeds with all new pages resolved by import.meta.glob.
  </verify>
  <done>
Create.tsx, Edit.tsx, BulkUpload.tsx pages exist and use useForm hook. FormField.tsx and ProgressBar.tsx reusable components exist. Index.tsx has navigation links to create and bulk upload. TypeScript compiles without errors. Vite build succeeds (import.meta.glob picks up all new Pages).
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/matt/src/itsascout/scrapegrape && uv run python manage.py check` -- Django system check passes
2. `cd /Users/matt/src/itsascout/scrapegrape/frontend && npm run build` -- Frontend builds successfully
3. Verify all new files exist:
   - `scrapegrape/publishers/forms.py`
   - `scrapegrape/frontend/src/Pages/Publishers/Create.tsx`
   - `scrapegrape/frontend/src/Pages/Publishers/Edit.tsx`
   - `scrapegrape/frontend/src/Pages/Publishers/BulkUpload.tsx`
   - `scrapegrape/frontend/src/Components/FormField.tsx`
   - `scrapegrape/frontend/src/Components/ProgressBar.tsx`
4. Verify views.py contains `_flash_errors` helper and session-based error pattern (NOT InertiaValidationError)
5. Verify middleware.py shares `errors` prop from session
6. Verify urls.py has routes for create, edit, bulk-upload
</verification>

<success_criteria>
- INRT-08 delivered: useForm hook handles all form submissions with validation error display
- Three form pages (Create, Edit, BulkUpload) render via Inertia
- Django forms validate server-side, errors pass through session + shared data to useForm
- CSV bulk upload shows progress percentage via form.progress
- Submit buttons show processing state and prevent double-submit
- Navigation links connect Index page to Create and BulkUpload pages
</success_criteria>

<output>
After completion, create `.planning/phases/04-interactive-features/04-01-SUMMARY.md`
</output>
