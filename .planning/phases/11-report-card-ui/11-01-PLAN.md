---
phase: 11-report-card-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scrapegrape/frontend/src/components/report/StatusIndicator.tsx
  - scrapegrape/frontend/src/components/report/PermissionStatus.tsx
  - scrapegrape/frontend/src/components/report/UrlList.tsx
  - scrapegrape/frontend/src/components/report/FormatBadge.tsx
  - scrapegrape/frontend/src/components/report/PaywallBadge.tsx
  - scrapegrape/frontend/src/Pages/Jobs/Show.tsx
  - scrapegrape/frontend/src/Pages/Publishers/Detail.tsx
autonomous: true

must_haves:
  truths:
    - "Completed job shows a structured report card with publisher-level findings (WAF, ToS, robots.txt, sitemap, RSS, RSL, metadata profile) instead of step cards"
    - "Completed job shows article-level findings (format badges, paywall status, crawl permission, metadata profile summary)"
    - "Running/pending jobs still show step cards with SSE streaming (existing behavior preserved)"
    - "Null/skipped results display gracefully (e.g. 'Not checked' or 'Skipped') instead of crashing"
  artifacts:
    - path: "scrapegrape/frontend/src/components/report/StatusIndicator.tsx"
      provides: "Shared StatusIndicator component extracted from Detail.tsx"
      exports: ["StatusIndicator"]
    - path: "scrapegrape/frontend/src/components/report/PermissionStatus.tsx"
      provides: "Shared PermissionStatus component"
      exports: ["PermissionStatus"]
    - path: "scrapegrape/frontend/src/components/report/UrlList.tsx"
      provides: "Shared UrlList component with collapsible overflow"
      exports: ["UrlList"]
    - path: "scrapegrape/frontend/src/components/report/FormatBadge.tsx"
      provides: "Shared FormatBadge component"
      exports: ["FormatBadge"]
    - path: "scrapegrape/frontend/src/components/report/PaywallBadge.tsx"
      provides: "Shared PaywallBadge component"
      exports: ["PaywallBadge"]
    - path: "scrapegrape/frontend/src/Pages/Jobs/Show.tsx"
      provides: "Report card view for completed jobs, step cards for running jobs"
    - path: "scrapegrape/frontend/src/Pages/Publishers/Detail.tsx"
      provides: "Refactored to import shared components from report/"
  key_links:
    - from: "scrapegrape/frontend/src/Pages/Jobs/Show.tsx"
      to: "scrapegrape/frontend/src/components/report/*"
      via: "import"
      pattern: "from '@/components/report/"
    - from: "scrapegrape/frontend/src/Pages/Publishers/Detail.tsx"
      to: "scrapegrape/frontend/src/components/report/*"
      via: "import"
      pattern: "from '@/components/report/"
---

<objective>
Build the report card UI for completed jobs on the Jobs/Show page. Extract shared components from Publishers/Detail.tsx into a `components/report/` directory, then create a rich report card view that replaces step cards when a job is completed.

Purpose: Users visiting a completed job URL should see structured, readable findings -- not pipeline step cards. This is the primary user-facing deliverable of the entire v2.0 milestone.
Output: Report card view in Jobs/Show.tsx, shared components in components/report/, Detail.tsx refactored to use shared components.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-report-card-ui/11-RESEARCH.md
@scrapegrape/frontend/src/Pages/Jobs/Show.tsx
@scrapegrape/frontend/src/Pages/Publishers/Detail.tsx
@scrapegrape/publishers/views.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared report components from Detail.tsx</name>
  <files>
    scrapegrape/frontend/src/components/report/StatusIndicator.tsx
    scrapegrape/frontend/src/components/report/PermissionStatus.tsx
    scrapegrape/frontend/src/components/report/UrlList.tsx
    scrapegrape/frontend/src/components/report/FormatBadge.tsx
    scrapegrape/frontend/src/components/report/PaywallBadge.tsx
    scrapegrape/frontend/src/Pages/Publishers/Detail.tsx
  </files>
  <action>
    Create `src/components/report/` directory and extract these components from Detail.tsx:

    1. **StatusIndicator.tsx** -- Extract the StatusIndicator function from Detail.tsx (lines 110-140). Same props: `{ label, value, icon, tooltip? }`. Uses Tooltip/TooltipProvider from `@/components/ui/tooltip`. Export as named export.

    2. **PermissionStatus.tsx** -- Extract PermissionStatus (lines 84-108). Props: `{ permission: "explicitly_permitted" | "explicitly_prohibited" | "conditional_ambiguous" }`. Uses CircleCheck, CircleX, CircleAlert from lucide-react.

    3. **UrlList.tsx** -- Extract UrlList (lines 142-195). Props: `{ urls: string[], emptyText?: string }`. Uses Collapsible from `@/components/ui/collapsible`, ExternalLink and ChevronRight from lucide-react.

    4. **FormatBadge.tsx** -- Extract FormatBadge (lines 197-203). Props: `{ label: string, present: boolean }`.

    5. **PaywallBadge.tsx** -- Extract PaywallBadge (lines 205-223). Props: `{ status: string }`.

    6. **Update Detail.tsx** -- Replace the inline component definitions with imports from `@/components/report/`. Remove the extracted function bodies. Add imports at the top:
       ```
       import { StatusIndicator } from "@/components/report/StatusIndicator"
       import { PermissionStatus } from "@/components/report/PermissionStatus"
       import { UrlList } from "@/components/report/UrlList"
       import { FormatBadge } from "@/components/report/FormatBadge"
       import { PaywallBadge } from "@/components/report/PaywallBadge"
       ```
       Remove now-unused direct imports from lucide-react and ui components that are only used by the extracted components (but keep imports still used by Detail.tsx itself).

    Keep all TypeScript types and component logic identical to the current Detail.tsx implementation -- this is a pure extraction, no behavior changes.
  </action>
  <verify>
    Run `npx tsc --noEmit` from `scrapegrape/frontend/` to verify TypeScript compiles. Run `npx vite build` to verify production build succeeds. Visually inspect that Detail.tsx still imports and uses all 5 shared components.
  </verify>
  <done>
    Five shared components exist in `components/report/`, Detail.tsx imports them instead of defining inline, TypeScript compiles, and Vite build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build report card view for completed jobs in Jobs/Show.tsx</name>
  <files>
    scrapegrape/frontend/src/Pages/Jobs/Show.tsx
  </files>
  <action>
    Refactor Jobs/Show.tsx so that completed jobs show a rich report card instead of step cards. Running/pending/failed jobs continue showing step cards with SSE (preserve all existing behavior).

    **Conditional rendering:** In the Show component, check `job.status === 'completed'`. If completed, render the ReportCard component (defined in the same file). Otherwise, render existing step cards + SSE logic (keep all current code intact).

    **ReportCard component structure** (follow Detail.tsx patterns closely):

    1. **Header** -- Same as current: truncated URL, status badge, publisher name/domain. Add a link to the publisher detail page: `<Link href={'/publishers/' + job.publisher_id}>View Publisher</Link>`. NOTE: `publisher_id` needs to be added to the job props (see below).

    2. **Status overview Card** -- Grid row with StatusIndicator components (like Detail.tsx lines 274-316):
       - WAF: `job.waf_result?.waf_detected ? (waf_type || "Detected") : "None"`. Null = "Not checked".
       - Robots.txt: `job.robots_result?.robots_found ? "Found" : "Not found"`. Null = "Not checked".
       - ToS: Derive from `job.tos_result?.permissions` array length -- show prohibited count or permitted count. Null = "Not checked".
       - RSL: `job.rsl_result?.rsl_detected ? "Detected" : "None"`. Null = "Not checked".
       - Feeds: Count of sitemap + RSS. `job.sitemap_result?.count ?? 0` sitemaps, `job.rss_result?.count ?? 0` RSS.

    3. **ToS Permissions section** -- Collapsible Card (like Detail.tsx lines 319-372). Extract permissions from `job.tos_result?.permissions` (array of {activity, permission, notes}). Show the same Table with PermissionStatus badges. If `job.tos_result?.tos_url`, show "View source" link. Handle null tos_result: show "Not checked".

    4. **Discovery section** -- Collapsible Card with:
       - Sitemaps: UrlList with `job.sitemap_result?.sitemap_urls ?? []`
       - RSS Feeds: UrlList with `job.rss_result?.feeds?.map(f => f.url) ?? []`
       - AI Bot Blocking: If `job.ai_bot_result?.bots`, show grid of bot names with blocked/allowed icons (like Detail.tsx lines 405-430). Show `blocked_count/total_count blocked` summary.
       - RSL: Simple line showing detected/not detected. If `job.rsl_result?.indicators`, show count.

    5. **Article Analysis section** -- Card (not collapsible, always visible):
       - **Crawl Permission** (from robots_result): "Allowed by robots.txt" / "Disallowed by robots.txt" using `job.robots_result?.url_allowed`. Show with Bot icon and PermissionStatus-style badge.
       - **Paywall Status**: PaywallBadge with `job.article_result?.paywall?.paywall_status ?? "unknown"`.
       - **Format Badges**: FormatBadge for each of json-ld, opengraph, microdata, twitter-cards. Check `job.article_result?.formats_found` array.
       - **Metadata Profile** (LLM summary): `job.article_result?.profile?.summary`. Display as paragraph text. If `job.article_result?.profile?.quality_score`, show as small badge.

    6. **Publisher details** (metadata_result): If `job.metadata_result?.found`, show organization name, type, source as a small info row below the header. Use `job.metadata_result?.organization?.name` etc.

    **Type updates:** Add `publisher_id: number` to the JobProps interface. This will be wired in the view update (same task -- see below about updating views.py).

    **Null handling everywhere:** Every section must guard with `if (!job.xxx_result) return <placeholder>` showing "Not checked" or "Skipped". Use a small helper: `function SectionPlaceholder({ label, reason }: { label: string; reason: string })` that renders a muted text message.

    **Keep all existing code:** The StepCard, stepDataSummary, PIPELINE_STEPS, statusBadge, SSE useEffect, mergedStatuses logic -- all stays. It is only rendered when `job.status !== 'completed'`.

    **Also update views.py** (`scrapegrape/publishers/views.py`): In the `job_show` function, add `"publisher_id": job.publisher.id` to the job props dict (alongside existing publisher_name and publisher_domain).
  </action>
  <verify>
    Run `npx tsc --noEmit` from `scrapegrape/frontend/` to verify TypeScript compiles. Run `npx vite build` to verify production build. Check that `publisher_id` is present in the job_show view props.
  </verify>
  <done>
    Completed jobs render a report card with: status overview grid (WAF, robots, ToS, RSL, feeds), collapsible ToS permissions table, collapsible discovery section (sitemaps, RSS, AI bots, RSL), article analysis section (crawl permission, paywall, format badges, metadata profile). Running jobs still show step cards with SSE. All null results handled gracefully. publisher_id added to view props.
  </done>
</task>

</tasks>

<verification>
1. `cd scrapegrape/frontend && npx tsc --noEmit` -- TypeScript compiles without errors
2. `cd scrapegrape/frontend && npx vite build` -- Production build succeeds
3. Five files exist in `src/components/report/`: StatusIndicator.tsx, PermissionStatus.tsx, UrlList.tsx, FormatBadge.tsx, PaywallBadge.tsx
4. Detail.tsx imports from `@/components/report/` (no inline definitions of extracted components)
5. Jobs/Show.tsx conditionally renders ReportCard for completed jobs, step cards for others
6. `uv run pytest scrapegrape/publishers/tests/test_views.py` -- existing view tests still pass
</verification>

<success_criteria>
- Completed job at /jobs/{id} shows publisher-level findings: WAF status, ToS permissions, robots.txt, sitemaps, RSS, RSL, metadata profile
- Completed job shows article-level findings: format badges, paywall status, crawl permission, metadata profile summary
- Running/pending jobs show step cards with real-time SSE updates (no regression)
- Null/missing results display placeholder text instead of crashing
- Shared components used by both Detail.tsx and Jobs/Show.tsx
</success_criteria>

<output>
After completion, create `.planning/phases/11-report-card-ui/11-01-SUMMARY.md`
</output>
