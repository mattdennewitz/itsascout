---
phase: 16-google-news-readiness
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - scrapegrape/publishers/pipeline/steps.py
  - scrapegrape/publishers/tests/test_pipeline.py
autonomous: true

must_haves:
  truths:
    - "run_google_news_step returns readiness 'strong' when all 3 signals present"
    - "run_google_news_step returns readiness 'none' when no signals present"
    - "run_google_news_step handles None inputs without crashing"
    - "NewsArticle subtypes (OpinionNewsArticle, etc.) are detected as news article signals"
    - "_extract_jsonld_article_fields includes @type in returned fields dict"
  artifacts:
    - path: "scrapegrape/publishers/pipeline/steps.py"
      provides: "run_google_news_step aggregation function and @type fix in _extract_jsonld_article_fields"
      contains: "def run_google_news_step"
    - path: "scrapegrape/publishers/tests/test_pipeline.py"
      provides: "Tests for Google News step and article extraction @type fix"
      contains: "test_google_news"
  key_links:
    - from: "scrapegrape/publishers/pipeline/steps.py"
      to: "run_google_news_step"
      via: "NEWS_ARTICLE_TYPES constant for subtype detection"
      pattern: "NEWS_ARTICLE_TYPES"
---

<objective>
Create the Google News readiness aggregation step function and fix article extraction to preserve @type.

Purpose: The step function aggregates three existing signals (news sitemap, NewsArticle schema, NewsMediaOrganization schema) into a readiness level. The @type fix ensures article extraction preserves the schema type for downstream consumers.

Output: `run_google_news_step()` in steps.py, @type included in `_extract_jsonld_article_fields()` output, comprehensive tests.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-google-news-readiness/16-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix _extract_jsonld_article_fields to include @type and add run_google_news_step with TDD tests</name>
  <files>scrapegrape/publishers/pipeline/steps.py, scrapegrape/publishers/tests/test_pipeline.py</files>
  <action>
**RED phase -- Write tests first:**

Add tests to `test_pipeline.py` for:

1. **@type preservation in article extraction:**
   - Test that `_extract_jsonld_article_fields([{"@type": "NewsArticle", "headline": "Test"}])` returns a dict containing `"@type": "NewsArticle"`
   - Test that `_extract_jsonld_article_fields([{"@type": "Article", "headline": "Test"}])` returns `"@type": "Article"` (not just news types)
   - Test existing behavior unchanged: headline, author, datePublished still extracted

2. **Google News step -- all signal combinations:**
   - `test_google_news_step_all_signals` -- all 3 present -> readiness "strong", signal_count 3
   - `test_google_news_step_two_signals` -- 2 of 3 present -> readiness "moderate"
   - `test_google_news_step_one_signal` -- 1 of 3 present -> readiness "minimal"
   - `test_google_news_step_no_signals` -- none present -> readiness "none", signal_count 0
   - `test_google_news_step_none_inputs` -- all inputs None -> readiness "none", no crash
   - `test_google_news_step_news_article_subtypes` -- OpinionNewsArticle in jsonld_fields["@type"] -> has_news_article_schema True

Test input shapes (from research):
- sitemap_analysis_result: `{"has_news_sitemap": True}`
- article_result: `{"jsonld_fields": {"@type": "NewsArticle", "headline": "..."}}`
- metadata_result: `{"organization": {"type": "NewsMediaOrganization", "name": "..."}}`

Run tests -- they MUST fail (step function doesn't exist yet, @type not preserved).

**GREEN phase -- Implement:**

1. In `_extract_jsonld_article_fields()` (around line 1100 in steps.py), after `fields: dict = {}` and before the `for field in KEY_FIELDS:` loop, add:
   ```python
   # Preserve @type for downstream consumers (e.g., Google News readiness step)
   matched_type = next(
       (t.split("/")[-1] for t in types if t.split("/")[-1] in ARTICLE_TYPES),
       None,
   )
   if matched_type:
       fields["@type"] = matched_type
   ```

2. Add `NEWS_ARTICLE_TYPES` constant near the existing `ARTICLE_TYPES` constant:
   ```python
   NEWS_ARTICLE_TYPES = {
       "NewsArticle", "OpinionNewsArticle", "AnalysisNewsArticle",
       "ReportageNewsArticle", "ReviewNewsArticle",
   }
   ```

3. Add `run_google_news_step()` function after the existing step functions (near end of steps.py, before helper functions or at module level). Follow the pattern from research:
   - Takes `sitemap_analysis_result`, `article_result`, `metadata_result` (all `dict | None`)
   - Signal 1: `(sitemap_analysis_result or {}).get("has_news_sitemap")` -> bool
   - Signal 2: Check if `jsonld_fields.get("@type", "")` contains any NEWS_ARTICLE_TYPES member using substring check
   - Signal 3: Check if `org.get("type") == "NewsMediaOrganization"`
   - Count signals, map to readiness level: 3=strong, 2=moderate, 1=minimal, 0=none
   - Return dict with keys: readiness, signals, signal_count, error (None)
   - Include `article_schema_type` and `org_schema_type` in signals dict for transparency

Run tests -- they MUST pass.

**REFACTOR phase:** Clean up if needed. Ensure no duplication. Run full test suite (`uv run pytest`) to verify no regressions.
  </action>
  <verify>`uv run pytest scrapegrape/publishers/tests/test_pipeline.py -v -k "google_news or jsonld_article_type"` -- all new tests pass. `uv run pytest` -- full suite passes with no regressions.</verify>
  <done>run_google_news_step returns correct readiness levels for all signal combinations. _extract_jsonld_article_fields includes @type in output. All tests pass.</done>
</task>

</tasks>

<verification>
1. `uv run pytest scrapegrape/publishers/tests/test_pipeline.py -v` -- all pipeline tests pass
2. `uv run pytest` -- full test suite passes (no regressions from @type fix)
3. `from scrapegrape.publishers.pipeline.steps import run_google_news_step` -- importable
4. Verify run_google_news_step handles None inputs gracefully
</verification>

<success_criteria>
- run_google_news_step exists and is importable
- Returns readiness levels: strong (3 signals), moderate (2), minimal (1), none (0)
- Handles None inputs without crashing
- Detects NewsArticle subtypes (OpinionNewsArticle, etc.)
- _extract_jsonld_article_fields now includes @type in returned dict
- All existing tests still pass (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/16-google-news-readiness/16-01-SUMMARY.md`
</output>
